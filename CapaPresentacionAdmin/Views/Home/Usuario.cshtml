@{
    ViewBag.Title = "Usuario";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Usuario</h2>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Usuarios Registrados</h6>
        <button class="btn btn-success btn-sm" id="btnAgregar" onclick="abrirModal(null)">Agregar Usuario</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Correo</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- User Information Modal -->
<div class="modal fade" id="UserFormModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="UserFormModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="UserFormModalLabel">Usuario</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input id="userid" type="hidden" value="0" />
                <form id="userForm">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtNombre">Nombre</label>
                                <input type="text" class="form-control required" id="txtNombre" name="nombre" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtApellido">Apellido</label>
                                <input type="text" class="form-control required" id="txtApellido" name="apellido" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtCorreo">Correo</label>
                                <input type="email" class="form-control required" id="txtCorreo" name="correo" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtClave">Clave</label>
                                <input type="password" class="form-control required" id="txtClave" name="clave" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="cboEstado">Estado</label>
                                <select id="cboEstado" class="form-select">
                                    <option value="1">Activo</option>
                                    <option value="0">No Activo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
        </div>
    </div>
</div>




<!-- Modal -->
<div class="modal fade" id="UserFormModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="UserFormModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="UserFormModalLabel">Usuario</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input id="userid" type="hidden" value="0" />
                <form id="userForm">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtNombre">Nombre</label>
                                <input type="text" class="form-control required" id="txtNombre" name="nombre" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtApellido">Apellido</label>
                                <input type="text" class="form-control required" id="txtApellido" name="apellido" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtCorreo">Correo</label>
                                <input type="email" class="form-control required" id="txtCorreo" name="correo" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="txtClave">Clave</label>
                                <input type="password" class="form-control required" id="txtClave" name="clave" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="cboEstado">Estado</label>
                                <select id="cboEstado" class="form-select">
                                    <option value="1">Activo</option>
                                    <option value="0">No Activo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-loading-overlay/2.1.7/loadingoverlay.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <script>
        $(document).ready(function () {
            console.log("Inicializando DataTable...");

            // Mostrar LoadingOverlay al cargar la página
            $.LoadingOverlay("show");

            // Inicializar DataTable
            var tabladta = $('#dataTable').DataTable({
                responsive: true,
                ordering: false,
                "ajax": {
                    "url": "@Url.Action("ListaUsuario", "Home")",
                    "type": "GET",
                    "dataType": "json",
                    "error": function (xhr, status, error) {
                        console.error("Error cargando DataTable:", xhr.responseText);
                    },
                    "complete": function () {
                        $.LoadingOverlay("hide");
                    }
                },
                "columns": [
                    { "data": "Nombre" },
                    { "data": "Apellido" },
                    { "data": "Correo" },
                    {
                        "data": "Activo",
                        "render": function (valor) {
                            return valor ? "<span class='badge badge-success'>Sí</span>" : "<span class='badge badge-danger'>No</span>";
                        }
                    },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<button class="btn btn-primary btn-sm btn-editar" data-id="${row.Id}">Editar</button>
                                    <button class="btn btn-danger btn-sm btn-eliminar" data-id="${row.Id}">Eliminar</button>`;
                        }
                    }
                ]
            });
            function abrirModal(json) {
                $("#userid").val(0);
                $("#txtNombre").val("");
                $("#txtApellido").val("");
                $("#txtCorreo").val("");
                $("#txtClave").val("");
                $("#cboEstado").val(1);

                if (json != null) {
                    $("#userid").val(json.IdUsuario);
                    $("#txtNombre").val(json.Nombre);
                    $("#txtApellido").val(json.Apellido);
                    $("#txtCorreo").val(json.Correo);
                    $("#txtClave").val(json.Clave);
                    $("#cboEstado").val(json.Activo == true ? 1 : 0);
                }

                $('#UserFormModal').modal('show');
            }

            // Evento para el botón "Agregar Usuario"
            $("#btnAgregar").click(function () {
                $.LoadingOverlay("show");
                $("#modalContent").load("@Url.Action("AgregarUsuario", "Home")", function () {
                    $.LoadingOverlay("hide");
                    $("#modalAgregarUsuario").modal("show");
                });
            });

            // Evento para guardar el nuevo usuario
            $(document).on("click", "#btnGuardarUsuario", function () {
                $.LoadingOverlay("show");
                var formData = $("#formAgregarUsuario").serialize();
                $.post("@Url.Action("AgregarUsuario", "Home")", formData, function (response) {
                    $.LoadingOverlay("hide");
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Usuario agregado con éxito'
                        });
                        $("#modalAgregarUsuario").modal("hide");
                        tabladta.ajax.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error agregando usuario: ' + response.message
                        });
                    }
                });
            });

            // Evento para botón "Eliminar"
            $("#dataTable tbody").on("click", ".btn-eliminar", function () {
                var id = $(this).data("id");
                Swal.fire({
                    title: '¿Seguro que quieres eliminar este usuario?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'No, cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.LoadingOverlay("show");
                        $.post("@Url.Action("EliminarUsuario", "Home")", { id: id }, function (response) {
                            $.LoadingOverlay("hide");
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Eliminado',
                                    text: 'Usuario eliminado con éxito'
                                });
                                tabladta.ajax.reload();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Error eliminando usuario: ' + response.message
                                });
                            }
                        });
                    }
                });
            });

            // Evento para botón "Editar"
            $("#dataTable tbody").on("click", ".btn-editar", function () {
                var id = $(this).data("id");
                $.LoadingOverlay("show");
                $("#modalContent").load("@Url.Action("EditarUsuario", "Home")", { id: id }, function () {
                    $.LoadingOverlay("hide");
                    $("#modalAgregarUsuario").modal("show");
                });
            });

            // Evento para guardar cambios del usuario editado
            $(document).on("click", "#btnGuardarCambiosUsuario", function () {
                $.LoadingOverlay("show");
                var formData = $("#formEditarUsuario").serialize();
                $.post("@Url.Action("EditarUsuario", "Home")", formData, function (response) {
                    $.LoadingOverlay("hide");
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Usuario editado con éxito'
                        });
                        $("#modalAgregarUsuario").modal("hide");
                        tabladta.ajax.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error editando usuario: ' + response.message
                        });
                    }
                });
            });
        });
    </script>
}
